<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=2.0">
    <title>GitLab Branch Diff & File Viewer</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Diff styling remains the same */
        .diff-line-added {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .diff-line-deleted {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .diff-line-common {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .diff-header {
            color: #2563eb;
            font-weight: bold;
        }

        .diff-info {
            color: #d97706;
        }

        .diff-hunk-header {
            background-color: #e0f2fe;
            color: #0369a1;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .diff-split-container {
            display: flex;
            width: 100%;
            border: 1px solid #afb4bd;
            border-radius: 0.5rem;
            overflow: hidden;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .diff-pane {
            flex: 1;
            padding: 0.5rem;
            overflow-x: auto;
            white-space: pre;
        }

        .diff-pane-left {
            border-right: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }

        .diff-line {
            display: flex;
            align-items: flex-start;
            min-height: 1.5em;
        }

        .diff-line-number {
            flex-shrink: 0;
            width: 3rem;
            text-align: right;
            padding-right: 0.5rem;
            color: #9ca3af;
            user-select: none;
        }

        .diff-line-content {
            flex-grow: 1;
            padding-left: 0.5rem;
            border-left: 1px solid transparent;
        }

        .diff-line-deleted .diff-line-content {
            border-left-color: #ef4444;
        }

        .diff-line-added .diff-line-content {
            border-left-color: #22c55e;
        }

        /* Styling for the file content display */
        .file-content-display {
            background-color: #1f2937;
            /* Dark background for code */
            color: #f9fafb;
            /* Light text for code */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre-wrap;
            /* Allows text to wrap but preserves whitespace */
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 p-4 text-gray-800 flex flex-col items-center">

    <div class="w-full max-w-full bg-white rounded-xl shadow-lg p-6 mb-8 mx-4">
        <h1 class="text-3xl font-bold text-center text-gray-700 mb-6 flex items-center justify-center">
            GitLab Branch Diff & File Viewer
        </h1>

        <div class="mb-6">
            <label for="repo-url" class="block text-gray-700 text-sm font-medium mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="inline-block mr-1 h-4 w-4">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L9.5 3.5"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L14.5 20.5"></path>
                </svg>
                GitLab Repository URL
            </label>
            <input type="text" id="repo-url"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                placeholder="e.g., https://gitlab.com/your-org/your-repo.git or git@gitlab.com:user/project.git" />
        </div>

        <div class="mb-6 text-sm text-gray-600 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <strong>Note:</strong> This application now reads your GitLab Personal Access Token (PAT) from a
            `.config` file on the server (e.g., `GITLAB_TOKEN = your_pat_here`).
            The PAT is no longer entered directly in the browser for security reasons.
        </div>

        <div class="mb-6">
            <button id="fetch-branches-btn"
                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-sm transition duration-300 ease-in-out flex items-center justify-center">
                <span id="fetch-branches-spinner" class="hidden animate-spin mr-2 h-5 w-5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2v4"></path>
                        <path d="M12 18v4"></path>
                        <path d="M4.93 4.93l2.83 2.83"></path>
                        <path d="M16.24 16.24l2.83 2.83"></path>
                        <path d="M2 12h4"></path>
                        <path d="M18 12h4"></path>
                        <path d="M4.93 19.07l2.83-2.83"></path>
                        <path d="M16.24 7.76l2.83-2.83"></path>
                    </svg>
                </span>
                <span id="fetch-branches-text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="mr-2 h-5 w-5">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                        <path d="M21 3v5h-5"></path>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        <path d="M3 21v-5h5"></path>
                    </svg>
                    Fetch Branches & Initialize
                </span>
            </button>
        </div>
        <div id="error-message"
            class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center">
        </div>
    </div>

    <div class="w-full max-w-full bg-white rounded-xl shadow-lg p-6 mb-8 mx-4">
        <h2 class="text-2xl font-bold text-gray-700 mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="mr-2 text-purple-600">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9A1.65 1.65 0 0 0 10 3.09V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </svg>
            Repository Details
        </h2>

        <button id="fetch-repo-details-btn"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center"
            disabled>
            <span id="repo-details-spinner" class="hidden animate-spin mr-2 h-5 w-5">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v4"></path>
                    <path d="M12 18v4"></path>
                    <path d="M4.93 4.93l2.83 2.83"></path>
                    <path d="M16.24 16.24l2.83 2.83"></path>
                    <path d="M2 12h4"></path>
                    <path d="M18 12h4"></path>
                    <path d="M4.93 19.07l2.83-2.83"></path>
                    <path d="M16.24 7.76l2.83-2.83"></path>
                </svg>
            </span>
            <span id="repo-details-text">Fetch Repository Details</span>
        </button>

        <div id="repo-details-error"
            class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center">
        </div>
    </div>

    <div id="repo-details-output-container"
        class="w-full max-w-full bg-white rounded-xl shadow-lg p-6 hidden mx-4 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Details:</h3>
        <pre id="repo-details-display" class="bg-gray-50 p-4 rounded-lg overflow-x-auto text-sm"></pre>
    </div>

    <div class="w-full max-w-full bg-white rounded-xl shadow-lg p-6 mb-8 mx-4">
        <h2 class="text-2xl font-bold text-gray-700 mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="mr-2 text-blue-500">
                <path d="M6 3v12"></path>
                <path d="M18 6H9a3 3 0 0 0-3 3v10"></path>
                <path d="M12 10 9 7 6 10"></path>
                <path d="M18 10 15 7 12 10"></path>
            </svg>
            Branch Comparison
        </h2>

        <div class="flex flex-col md:flex-row gap-6 mb-6">
            <div class="flex-1">
                <label for="branch1" class="block text-gray-700 text-sm font-medium mb-2">
                    Select Base Branch
                </label>
                <select id="branch1"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                    disabled>
                    <option value="">No branches available</option>
                </select>
            </div>

            <div class="flex-1">
                <label for="branch2" class="block text-gray-700 text-sm font-medium mb-2">
                    Select Compare Branch
                </label>
                <select id="branch2"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                    disabled>
                    <option value="">No branches available</option>
                </select>
            </div>
        </div>

        <button id="compare-branches-btn"
            class="w-full bg-gray-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center"
            disabled>
            <span id="compare-spinner" class="hidden animate-spin mr-2 h-5 w-5">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v4"></path>
                    <path d="M12 18v4"></path>
                    <path d="M4.93 4.93l2.83 2.83"></path>
                    <path d="M16.24 16.24l2.83 2.83"></path>
                    <path d="M2 12h4"></path>
                    <path d="M18 12h4"></path>
                    <path d="M4.93 19.07l2.83-2.83"></path>
                    <path d="M16.24 7.76l2.83-2.83"></path>
                </svg>
            </span>
            <span id="compare-text">Compare Branches</span>
        </button>

    </div>

    <div id="diff-output-container" class="w-full max-w-full bg-white rounded-xl shadow-lg p-6 hidden mx-4 mb-8">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">Comparison Results</h2>
        <div id="diff-display" class="w-full">
        </div>
    </div>


    <div class="w-full max-w-full bg-white rounded-xl shadow-lg p-6 mb-8 mx-4">
        <h2 class="text-2xl font-bold text-gray-700 mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="mr-2 text-green-600">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <line x1="10" y1="9" x2="8" y2="9"></line>
            </svg>
            View Single File Content
        </h2>

        <div class="mb-4">
            <label for="file-content-branch" class="block text-gray-700 text-sm font-medium mb-2">
                Select Branch/Ref
            </label>
            <select id="file-content-branch"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
                disabled>
                <option value="">No branches available</option>
            </select>
        </div>

        <div class="mb-6">
            <label for="file-path" class="block text-gray-700 text-sm font-medium mb-2">
                File Path (e.g., `src/main.py` or `README.md`)
            </label>
            <input type="text" id="file-path"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                placeholder="Enter file path relative to repository root" />
        </div>

        <button id="fetch-file-content-btn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center"
            disabled>
            <span id="file-content-spinner" class="hidden animate-spin mr-2 h-5 w-5">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v4"></path>
                    <path d="M12 18v4"></path>
                    <path d="M4.93 4.93l2.83 2.83"></path>
                    <path d="M16.24 16.24l2.83 2.83"></path>
                    <path d="M2 12h4"></path>
                    <path d="M18 12h4"></path>
                    <path d="M4.93 19.07l2.83-2.83"></path>
                    <path d="M16.24 7.76l2.83-2.83"></path>
                </svg>
            </span>
            <span id="file-content-text">Fetch File Content</span>
        </button>
        <div id="file-content-error"
            class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center">
        </div>
    </div>

    <div id="file-content-output-container" class="w-full max-w-full bg-white rounded-xl shadow-lg p-6 hidden mx-4">
        <h2 class="text-2xl font-bold text-green-700 mb-4">File Content</h2>
        <pre id="file-content-display" class="file-content-display"></pre>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded. Initializing script.');
            const repoUrlInput = document.getElementById('repo-url');
            const errorMessageDiv = document.getElementById('error-message');

            const fetchBranchesBtn = document.getElementById('fetch-branches-btn');
            const fetchBranchesSpinner = document.getElementById('fetch-branches-spinner');
            const fetchBranchesText = document.getElementById('fetch-branches-text');

            // Branch Comparison Elements
            const branch1Select = document.getElementById('branch1');
            const branch2Select = document.getElementById('branch2');
            const compareBranchesBtn = document.getElementById('compare-branches-btn');
            const compareSpinner = document.getElementById('compare-spinner');
            const compareText = document.getElementById('compare-text');
            const diffOutputContainer = document.getElementById('diff-output-container');
            const diffDisplayDiv = document.getElementById('diff-display');

            // File Content Viewer Elements
            const fileContentBranchSelect = document.getElementById('file-content-branch');
            const filePathInput = document.getElementById('file-path');
            const fetchFileContentBtn = document.getElementById('fetch-file-content-btn');
            const fileContentSpinner = document.getElementById('file-content-spinner');
            const fileContentText = document.getElementById('file-content-text');
            const fileContentOutputContainer = document.getElementById('file-content-output-container');
            const fileContentDisplayDiv = document.getElementById('file-content-display');
            const fileContentErrorDiv = document.getElementById('file-content-error');

            // Repository Details Elements
            const fetchRepoDetailsBtn = document.getElementById('fetch-repo-details-btn');
            const repoDetailsSpinner = document.getElementById('repo-details-spinner');
            const repoDetailsText = document.getElementById('repo-details-text');
            const repoDetailsOutputContainer = document.getElementById('repo-details-output-container');
            const repoDetailsDisplay = document.getElementById('repo-details-display');
            const repoDetailsErrorDiv = document.getElementById('repo-details-error');


            const showError = (message, targetDiv = errorMessageDiv) => {
                console.error('Displaying error:', message);
                targetDiv.textContent = message;
                targetDiv.classList.remove('hidden');
            };

            const hideError = (targetDiv = errorMessageDiv) => {
                targetDiv.classList.add('hidden');
                targetDiv.textContent = '';
            };

            const populateDropdown = (selectElement, options) => {
                selectElement.innerHTML = '';
                if (options.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No branches available';
                    selectElement.appendChild(option);
                    selectElement.disabled = true;
                } else {
                    options.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        selectElement.appendChild(option);
                    });
                    selectElement.disabled = false;
                }
            };

            const renderSplitDiff = (rawDiff) => {
                diffDisplayDiv.innerHTML = '';
                diffOutputContainer.classList.remove('hidden');

                if (!rawDiff || rawDiff.trim() === '') {
                    const noDiffMessage = document.createElement('p');
                    noDiffMessage.className = 'text-center text-gray-600 p-4';
                    noDiffMessage.textContent = 'No differences found between the selected branches.';
                    diffDisplayDiv.appendChild(noDiffMessage);
                    return;
                }

                const lines = rawDiff.split('\n');
                let currentFileDiff = [];
                let inDiffBlock = false;

                lines.forEach(line => {
                    if (line.startsWith('diff --git')) {
                        if (inDiffBlock) {
                            appendFileDiff(currentFileDiff);
                        }
                        currentFileDiff = [line];
                        inDiffBlock = true;
                    } else if (inDiffBlock) {
                        currentFileDiff.push(line);
                    }
                });

                if (inDiffBlock) {
                    appendFileDiff(currentFileDiff);
                }
            };

            const appendFileDiff = (fileLines) => {
                if (fileLines.length === 0) return;

                const fileNameLine = fileLines.find(line => line.startsWith('--- a/'));
                const fileName = fileNameLine ? fileNameLine.substring(6).split('\t')[0] : 'Unknown File';

                const fileHeader = document.createElement('h3');
                fileHeader.className = 'text-lg font-semibold text-gray-800 mt-6 mb-2 flex items-center';

                fileHeader.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-500"><path d="M4 22h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8a2 2 0 0 1-2-2V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"></path></svg>${fileName}`;
                diffDisplayDiv.appendChild(fileHeader);

                const splitContainer = document.createElement('div');
                splitContainer.className = 'diff-split-container mb-4';

                const leftPane = document.createElement('div');
                leftPane.className = 'diff-pane diff-pane-left';
                const rightPane = document.createElement('div');
                rightPane.className = 'diff-pane diff-pane-right';

                let leftLineNum = 0;
                let rightLineNum = 0;
                let currentHunkStartLeft = 0;
                let currentHunkStartRight = 0;

                fileLines.forEach(line => {
                    const lineDivLeft = document.createElement('div');
                    lineDivLeft.className = 'diff-line';
                    const lineDivRight = document.createElement('div');
                    lineDivRight.className = 'diff-line';

                    const lineNumberLeft = document.createElement('span');
                    lineNumberLeft.className = 'diff-line-number';
                    const contentLeft = document.createElement('span');
                    contentLeft.className = 'diff-line-content';

                    const lineNumberRight = document.createElement('span');
                    lineNumberRight.className = 'diff-line-number';
                    const contentRight = document.createElement('span');
                    contentRight.className = 'diff-line-content';

                    if (line.startsWith('@@')) {
                        const hunkMatch = line.match(/@@ -(\d+)(,\d+)? \+(\d+)(,\d+)? @@/);
                        if (hunkMatch) {
                            currentHunkStartLeft = parseInt(hunkMatch[1], 10);
                            currentHunkStartRight = parseInt(hunkMatch[3], 10);
                            leftLineNum = currentHunkStartLeft;
                            rightLineNum = currentHunkStartRight;
                        }
                        const hunkHeaderDiv = document.createElement('div');
                        hunkHeaderDiv.className = 'diff-hunk-header col-span-2 w-full text-center py-1';
                        hunkHeaderDiv.textContent = line;
                        leftPane.appendChild(hunkHeaderDiv.cloneNode(true));
                        rightPane.appendChild(hunkHeaderDiv);
                        return;
                    } else if (line.startsWith('--- a/') || line.startsWith('+++ b/')) {
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'diff-info col-span-2 w-full';
                        infoDiv.textContent = line;
                        leftPane.appendChild(infoDiv.cloneNode(true));
                        rightPane.appendChild(infoDiv);
                        return;
                    } else if (line.startsWith('diff --git') || line.startsWith('index ')) {
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'diff-header col-span-2 w-full';
                        headerDiv.textContent = line;
                        leftPane.appendChild(headerDiv.cloneNode(true));
                        rightPane.appendChild(headerDiv);
                        return;
                    }

                    if (line.startsWith('-')) {
                        lineNumberLeft.textContent = leftLineNum;
                        contentLeft.textContent = line;
                        lineDivLeft.classList.add('diff-line-deleted');
                        lineDivLeft.appendChild(lineNumberLeft);
                        lineDivLeft.appendChild(contentLeft);
                        leftPane.appendChild(lineDivLeft);

                        const emptyLineRight = document.createElement('div');
                        emptyLineRight.className = 'diff-line';
                        emptyLineRight.innerHTML = `<span class="diff-line-number"></span><span class="diff-line-content"></span>`;
                        rightPane.appendChild(emptyLineRight);
                        leftLineNum++;
                    } else if (line.startsWith('+')) {
                        lineNumberRight.textContent = rightLineNum;
                        contentRight.textContent = line;
                        lineDivRight.classList.add('diff-line-added');
                        lineDivRight.appendChild(lineNumberRight);
                        lineDivRight.appendChild(contentRight);
                        rightPane.appendChild(lineDivRight);

                        const emptyLineLeft = document.createElement('div');
                        emptyLineLeft.className = 'diff-line';
                        emptyLineLeft.innerHTML = `<span class="diff-line-number"></span><span class="diff-line-content"></span>`;
                        leftPane.appendChild(emptyLineLeft);
                        rightLineNum++;
                    } else {
                        lineNumberLeft.textContent = leftLineNum;
                        contentLeft.textContent = line;
                        lineDivLeft.classList.add('diff-line-common');
                        lineDivLeft.appendChild(lineNumberLeft);
                        lineDivLeft.appendChild(contentLeft);
                        leftPane.appendChild(lineDivLeft);

                        lineNumberRight.textContent = rightLineNum;
                        contentRight.textContent = line;
                        lineDivRight.classList.add('diff-line-common');
                        lineDivRight.appendChild(lineNumberRight);
                        lineDivRight.appendChild(contentRight);
                        rightPane.appendChild(lineDivRight);

                        leftLineNum++;
                        rightLineNum++;
                    }
                });

                splitContainer.appendChild(leftPane);
                splitContainer.appendChild(rightPane);
                diffDisplayDiv.appendChild(splitContainer);
            };

            fetchBranchesBtn.addEventListener('click', async () => {
                console.log('Fetch Branches button clicked!');
                hideError();
                hideError(fileContentErrorDiv);
                hideError(repoDetailsErrorDiv);

                const repoUrl = repoUrlInput.value.trim();

                if (!repoUrl) {
                    showError('Please enter GitLab Repository URL.');
                    console.log('Missing Repo URL.');
                    return;
                }

                fetchBranchesBtn.disabled = true;
                fetchBranchesSpinner.classList.remove('hidden');
                fetchBranchesText.classList.add('hidden');
                console.log('Fetch Branches button disabled, spinner shown.');

                // Disable other sections immediately
                branch1Select.disabled = true;
                branch2Select.disabled = true;
                compareBranchesBtn.disabled = true;
                diffOutputContainer.classList.add('hidden');

                fileContentBranchSelect.disabled = true;
                filePathInput.value = ''; // Clear file path input
                fetchFileContentBtn.disabled = true;
                fileContentOutputContainer.classList.add('hidden');

                fetchRepoDetailsBtn.disabled = true; // Disable repo details button
                repoDetailsOutputContainer.classList.add('hidden');


                try {
                    console.log('Attempting to fetch branches from API...');
                    const response = await fetch('/api/branches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            repoUrl: repoUrl
                        }),
                    });

                    console.log('Response received:', response);
                    const data = await response.json();
                    console.log('Parsed response data:', data);

                    if (response.ok) {
                        populateDropdown(branch1Select, data.branches);
                        populateDropdown(branch2Select, data.branches);
                        populateDropdown(fileContentBranchSelect, data.branches);

                        console.log('Branches populated:', data.branches);

                        if (data.branches.length > 0) {
                            branch1Select.value = data.branches[0];
                            if (data.branches.length > 1) {
                                branch2Select.value = data.branches[1];
                                fileContentBranchSelect.value = data.branches[0];
                            } else {
                                branch2Select.value = data.branches[0];
                                fileContentBranchSelect.value = data.branches[0];
                            }
                        } else {
                            showError('No branches found for this repository or access denied. Check URL and server-side PAT configuration.');
                            console.log('No branches found.');
                        }
                    } else {
                        showError(data.error || 'Failed to fetch branches. Check server logs for details.');
                        console.error('API response not OK:', data.error);
                    }
                } catch (error) {
                    console.error('Error fetching branches:', error);
                    showError('Network error or server unavailable. Could not fetch branches.');
                } finally {
                    fetchBranchesBtn.disabled = false;
                    fetchBranchesSpinner.classList.add('hidden');
                    fetchBranchesText.classList.remove('hidden');
                    updateAllButtonStates(); // Update all buttons after branches are fetched
                    console.log('Fetch Branches button re-enabled, spinner hidden.');
                }
            });

            compareBranchesBtn.addEventListener('click', async () => {
                console.log('Compare Branches button clicked!');
                hideError();
                const repoUrl = repoUrlInput.value.trim();
                const branch1 = branch1Select.value;
                const branch2 = branch2Select.value;

                if (!repoUrl || !branch1 || !branch2) {
                    showError('Please ensure Repository URL and both branches are selected.');
                    console.log('Missing inputs for compare.');
                    return;
                }

                if (branch1 === branch2) {
                    showError('Please select two different branches to compare.');
                    console.log('Same branches selected for compare.');
                    return;
                }

                compareBranchesBtn.disabled = true;
                compareSpinner.classList.remove('hidden');
                compareText.classList.add('hidden');
                diffOutputContainer.classList.add('hidden');
                console.log('Compare Branches button disabled, spinner shown.');

                try {
                    console.log('Attempting to fetch diff from API...');
                    const response = await fetch('/api/diff', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            repoUrl: repoUrl,
                            branch1: branch1,
                            branch2: branch2
                        }),
                    });

                    console.log('Response received for diff:', response);
                    const data = await response.json();
                    console.log('Parsed response data for diff:', data);

                    if (response.ok) {
                        renderSplitDiff(data.diff);
                    } else {
                        showError(data.error || 'Failed to fetch diff. Check server logs for details.');
                        console.error('API response not OK for diff:', data.error);
                    }
                } catch (error) {
                    console.error('Error fetching diff:', error);
                    showError('Network error or server unavailable. Could not fetch diff.');
                } finally {
                    compareBranchesBtn.disabled = false;
                    compareSpinner.classList.add('hidden');
                    compareText.classList.remove('hidden');
                    console.log('Compare Branches button re-enabled, spinner hidden.');
                }
            });


            // Fetch File Content Event Listener
            fetchFileContentBtn.addEventListener('click', async () => {
                console.log('Fetch File Content button clicked!');
                hideError(fileContentErrorDiv);
                fileContentOutputContainer.classList.add('hidden');

                const repoUrl = repoUrlInput.value.trim();
                const filePath = filePathInput.value.trim();
                const ref = fileContentBranchSelect.value;

                if (!repoUrl || !filePath || !ref) {
                    showError('Please ensure Repository URL, File Path, and Branch/Ref are all provided.', fileContentErrorDiv);
                    console.log('Missing inputs for file content fetch.');
                    return;
                }

                fetchFileContentBtn.disabled = true;
                fileContentSpinner.classList.remove('hidden');
                fileContentText.classList.add('hidden');
                fileContentDisplayDiv.textContent = '';
                console.log('Fetch File Content button disabled, spinner shown.');


                try {
                    console.log('Attempting to fetch file content from API...');
                    const response = await fetch('/api/file_content', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            repoUrl: repoUrl,
                            filePath: filePath,
                            ref: ref
                        }),
                    });

                    console.log('Response received for file content:', response);
                    const data = await response.json();
                    console.log('Parsed response data for file content:', data);


                    if (response.ok) {
                        fileContentDisplayDiv.textContent = data.content;
                        fileContentOutputContainer.classList.remove('hidden');
                    } else {
                        showError(data.error || 'Failed to fetch file content. Check server logs for details.', fileContentErrorDiv);
                        console.error('API response not OK for file content:', data.error);
                    }
                } catch (error) {
                    console.error('Error fetching file content:', error);
                    showError('Network error or server unavailable. Could not fetch file content.', fileContentErrorDiv);
                } finally {
                    fetchFileContentBtn.disabled = false;
                    fileContentSpinner.classList.add('hidden');
                    fileContentText.classList.remove('hidden');
                    console.log('Fetch File Content button re-enabled, spinner hidden.');
                }
            });

            // Fetch Repository Details Event Listener
            fetchRepoDetailsBtn.addEventListener('click', async () => {
                console.log('Fetch Repository Details button clicked!');
                hideError(repoDetailsErrorDiv);
                repoDetailsOutputContainer.classList.add('hidden');
                repoDetailsDisplay.textContent = '';

                const repoUrl = repoUrlInput.value.trim();

                if (!repoUrl) {
                    showError('Please enter GitLab Repository URL.', repoDetailsErrorDiv);
                    return;
                }

                fetchRepoDetailsBtn.disabled = true;
                repoDetailsSpinner.classList.remove('hidden');
                repoDetailsText.classList.add('hidden');

                try {
                    console.log('Attempting to fetch repository details from API...');
                    const response = await fetch('/api/repo_details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            repoUrl: repoUrl
                        }),
                    });

                    const data = await response.json();
                    console.log('Parsed response data for repo details:', data);

                    if (response.ok) {
                        // Format the output nicely
                        let detailsHtml = `
                            <strong>Name:</strong> ${data.name} (<a href="${data.web_url}" target="_blank" class="text-blue-600 hover:underline">${data.path_with_namespace}</a>)<br>
                            <strong>ID:</strong> ${data.id}<br>
                            <strong>Description:</strong> ${data.description || 'N/A'}<br>
                            <strong>Default Branch:</strong> ${data.default_branch || 'N/A'}<br>
                            <strong>Visibility:</strong> ${data.visibility}<br>
                            <strong>Created At:</strong> ${new Date(data.created_at).toLocaleString()}<br>
                            <strong>Last Activity At:</strong> ${new Date(data.last_activity_at).toLocaleString()}<br>
                            <strong>Forks:</strong> ${data.forks_count}<br>
                            <strong>Stars:</strong> ${data.star_count}<br>
                            <strong>Open Issues:</strong> ${data.open_issues_count}<br>
                            <strong>Archived:</strong> ${data.archived ? 'Yes' : 'No'}<br>
                            <strong>Empty Repo:</strong> ${data.empty_repo ? 'Yes' : 'No'}<br>
                            <strong>License:</strong> ${data.license || 'N/A'}<br>
                        `;

                        if (data.statistics) {
                            detailsHtml += `<br><strong>Statistics:</strong><br>`;
                            for (const key in data.statistics) {
                                let value = data.statistics[key];
                                if (key.includes('size') && value !== null) { // Convert bytes to MB/GB for display
                                    const sizeInMB = value / (1024 * 1024);
                                    if (sizeInMB >= 1024) {
                                        value = `${(sizeInMB / 1024).toFixed(2)} GB`;
                                    } else {
                                        value = `${sizeInMB.toFixed(2)} MB`;
                                    }
                                }
                                if (value !== null) { // Only show if not null
                                    detailsHtml += `&nbsp;&nbsp;&nbsp;&nbsp;<strong>${key.replace(/_/g, ' ').replace('count', 'Count').replace('size', 'Size')}:</strong> ${value}<br>`;
                                }
                            }
                        }

                        repoDetailsDisplay.innerHTML = detailsHtml;
                        repoDetailsOutputContainer.classList.remove('hidden');
                    } else {
                        showError(data.error || 'Failed to fetch repository details. Check server logs for details.', repoDetailsErrorDiv);
                    }
                } catch (error) {
                    console.error('Error fetching repo details:', error);
                    showError('Network error or server unavailable. Could not fetch repository details.', repoDetailsErrorDiv);
                } finally {
                    fetchRepoDetailsBtn.disabled = false;
                    repoDetailsSpinner.classList.add('hidden');
                    repoDetailsText.classList.remove('hidden');
                }
            });


            const updateCompareButtonState = () => {
                const b1 = branch1Select.value;
                const b2 = branch2Select.value;
                const repoUrl = repoUrlInput.value.trim();

                const shouldBeDisabled = !(
                    repoUrl &&
                    b1 && b2 && b1 !== b2
                );
                compareBranchesBtn.disabled = shouldBeDisabled;
                console.log('Update Compare Button State. Disabled:', shouldBeDisabled);
            };

            const updateFileContentButtonState = () => {
                const repoUrl = repoUrlInput.value.trim();
                const filePath = filePathInput.value.trim();
                const ref = fileContentBranchSelect.value;

                const shouldBeDisabled = !(
                    repoUrl &&
                    filePath &&
                    ref
                );
                fetchFileContentBtn.disabled = shouldBeDisabled;
                console.log('Update File Content Button State. Disabled:', shouldBeDisabled);
            };

            const updateRepoDetailsButtonState = () => {
                const repoUrl = repoUrlInput.value.trim();

                const shouldBeDisabled = !(
                    repoUrl
                );
                fetchRepoDetailsBtn.disabled = shouldBeDisabled;
                console.log('Update Repo Details Button State. Disabled:', shouldBeDisabled);
            };

            const updateAllButtonStates = () => {
                updateCompareButtonState();
                updateFileContentButtonState();
                updateRepoDetailsButtonState();
            };


            // Add event listeners to input fields and select dropdowns to update button state dynamically
            repoUrlInput.addEventListener('input', updateAllButtonStates);
            branch1Select.addEventListener('change', updateCompareButtonState);
            branch2Select.addEventListener('change', updateCompareButtonState);
            filePathInput.addEventListener('input', updateFileContentButtonState);
            fileContentBranchSelect.addEventListener('change', updateFileContentButtonState);

            // Initial state update on page load
            updateAllButtonStates();
            console.log('Initial button states updated.');
        });
    </script>
</body>

</html>