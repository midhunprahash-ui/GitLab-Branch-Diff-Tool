<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab Repo & Branch Diff Tool</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2,
        h3 {
            color: #343a40;
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: bold;
        }

        pre {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
        }

        .diff-container {
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }

        .file-path-header {
            font-weight: bold;
            cursor: pointer;
            color: #007bff;
            /* Bootstrap primary color for links */
            text-decoration: underline;
            margin-bottom: 5px;
        }

        .diff-content {
            background-color: #f1f3f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            border: 1px solid #ced4da;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-4">GitLab Repository and Branch Comparison</h1>

        <div class="form-group">
            <label for="gitlabUrl">GitLab URL (e.g., https://gitlab.organization.com or https://gitlab.com):</label>
            <input type="text" id="gitlabUrl" class="form-control" value="https://gitlab.com"
                placeholder="Enter GitLab URL" required>
        </div>

        <div class="form-group">
            <label for="pat">Personal Access Token (PAT):</label>
            <input type="password" id="pat" class="form-control" placeholder="Enter PAT" required>
        </div>

        <div class="form-group">
            <label for="username">Username (Optional - for context/PAT owner):</label>
            <input type="text" id="username" class="form-control" placeholder="Enter Username">
        </div>

        <button class="btn btn-primary btn-block mb-4" onclick="fetchRepositories()">List Repositories</button>

        <div id="errorMessages" class="alert alert-danger" style="display:none;"></div>

        <div class="form-group">
            <label for="repositorySelect">Select Repository:</label>
            <select id="repositorySelect" class="form-control" onchange="fetchBranches()" disabled>
                <option value="">-- Select a repository --</option>
            </select>
        </div>

        <div class="row">
            <div class="col-md-6 form-group">
                <label for="fromBranchSelect">From Branch:</label>
                <select id="fromBranchSelect" class="form-control" disabled>
                    <option value="">-- Select a branch --</option>
                </select>
            </div>
            <div class="col-md-6 form-group">
                <label for="toBranchSelect">To Branch:</label>
                <select id="toBranchSelect" class="form-control" disabled>
                    <option value="">-- Select a branch --</option>
                </select>
            </div>
        </div>

        <button class="btn btn-success btn-block mb-4" onclick="compareBranches()" disabled>Compare Branches</button>

        <div id="comparisonResults" class="mt-4">
            <h2>Comparison Results</h2>
            <div id="commitsDiv"></div>
            <div id="diffsDiv" class="mt-4"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api'; // Flask API base URL

        async function fetchRepositories() {
            const gitlabUrl = document.getElementById('gitlabUrl').value;
            const pat = document.getElementById('pat').value;
            const username = document.getElementById('username').value;
            const errorMessagesDiv = document.getElementById('errorMessages');
            const repositorySelect = document.getElementById('repositorySelect');

            errorMessagesDiv.style.display = 'none';
            errorMessagesDiv.textContent = '';
            repositorySelect.innerHTML = '<option value="">-- Select a repository --</option>';
            repositorySelect.disabled = true;
            document.getElementById('fromBranchSelect').disabled = true;
            document.getElementById('toBranchSelect').disabled = true;
            document.querySelector('button[onclick="compareBranches()"]').disabled = true;
            document.getElementById('commitsDiv').innerHTML = '';
            document.getElementById('diffsDiv').innerHTML = '';


            if (!gitlabUrl || !pat) {
                displayError('Please enter both GitLab URL and Personal Access Token.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/get_repos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gitlab_url: gitlabUrl, pat: pat, username: username })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitLab API error: ${response.status}: ${errorData.error || 'Unknown error'}`);
                }

                const repositories = await response.json();

                if (repositories.length === 0) {
                    displayError('No repositories found for the provided PAT and URL. Check permissions or PAT.');
                    return;
                }

                repositories.forEach(repo => {
                    const option = document.createElement('option');
                    option.value = repo.id;
                    option.textContent = repo.path_with_namespace;
                    repositorySelect.appendChild(option);
                });
                repositorySelect.disabled = false;

            } catch (error) {
                console.error("Fetch repositories error:", error);
                displayError(`Failed to fetch repositories: ${error.message}`);
            }
        }

        async function fetchBranches() {
            const gitlabUrl = document.getElementById('gitlabUrl').value;
            const pat = document.getElementById('pat').value;
            const repositoryId = document.getElementById('repositorySelect').value;
            const fromBranchSelect = document.getElementById('fromBranchSelect');
            const toBranchSelect = document.getElementById('toBranchSelect');
            const errorMessagesDiv = document.getElementById('errorMessages');

            errorMessagesDiv.style.display = 'none';
            errorMessagesDiv.textContent = '';
            fromBranchSelect.innerHTML = '<option value="">-- Select a branch --</option>';
            toBranchSelect.innerHTML = '<option value="">-- Select a branch --</option>';
            fromBranchSelect.disabled = true;
            toBranchSelect.disabled = true;
            document.querySelector('button[onclick="compareBranches()"]').disabled = true;
            document.getElementById('commitsDiv').innerHTML = '';
            document.getElementById('diffsDiv').innerHTML = '';

            if (!repositoryId) {
                return; // No repository selected
            }

            try {
                const response = await fetch(`${API_BASE_URL}/get_branches/${repositoryId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gitlab_url: gitlabUrl, pat: pat })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitLab API error: ${response.status}: ${errorData.error || 'Unknown error'}`);
                }

                const branches = await response.json();

                if (branches.length === 0) {
                    displayError('No branches found for this repository.');
                    return;
                }

                branches.forEach(branch => {
                    const option1 = document.createElement('option');
                    option1.value = branch;
                    option1.textContent = branch;
                    fromBranchSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = branch;
                    option2.textContent = branch;
                    toBranchSelect.appendChild(option2);
                });
                fromBranchSelect.disabled = false;
                toBranchSelect.disabled = false;
                document.querySelector('button[onclick="compareBranches()"]').disabled = false;


            } catch (error) {
                console.error("Fetch branches error:", error);
                displayError(`Failed to fetch branches: ${error.message}`);
            }
        }

        async function compareBranches() {
            const gitlabUrl = document.getElementById('gitlabUrl').value;
            const pat = document.getElementById('pat').value;
            const repositoryId = document.getElementById('repositorySelect').value;
            const fromBranch = document.getElementById('fromBranchSelect').value;
            const toBranch = document.getElementById('toBranchSelect').value;
            const errorMessagesDiv = document.getElementById('errorMessages');

            errorMessagesDiv.style.display = 'none';
            errorMessagesDiv.textContent = '';
            document.getElementById('commitsDiv').innerHTML = '';
            document.getElementById('diffsDiv').innerHTML = '';

            if (!repositoryId || !fromBranch || !toBranch) {
                displayError('Please select a repository and two branches to compare.');
                return;
            }

            if (fromBranch === toBranch) {
                displayError('Please select two different branches to compare.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/compare_branches/${repositoryId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gitlab_url: gitlabUrl, pat: pat, from_branch: fromBranch, to_branch: toBranch })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitLab API error: ${response.status}: ${errorData.error || 'Unknown error'}`);
                }

                const comparison = await response.json();
                displayComparison(comparison);

            } catch (error) {
                console.error("Error during comparison:", error);
                displayError(`Failed to compare branches: ${error.message}`);
            }
        }

        function displayComparison(comparison) {
            const commitsDiv = document.getElementById('commitsDiv');
            const diffsDiv = document.getElementById('diffsDiv');

            commitsDiv.innerHTML = '<h3>Commits</h3>';
            if (comparison.commits && comparison.commits.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group';
                comparison.commits.forEach(commit => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<strong>${commit.title}</strong><br>
                                    <small>ID: ${commit.short_id} by ${commit.author_name} on ${new Date(commit.authored_date).toLocaleString()}</small>`;
                    ul.appendChild(li);
                });
                commitsDiv.appendChild(ul);
            } else {
                commitsDiv.innerHTML += '<p>No commits found between the selected branches.</p>';
            }

            // Display diffs with toggle functionality
            diffsDiv.innerHTML = '<h3>File Changes (Diffs)</h3>';
            if (comparison.diffs && comparison.diffs.length > 0) {
                comparison.diffs.forEach(diff => {
                    const diffContainer = document.createElement('div');
                    diffContainer.className = 'diff-container';

                    const filePathHeader = document.createElement('div');
                    filePathHeader.className = 'file-path-header';
                    filePathHeader.innerHTML = `<strong>${diff.old_path} &rarr; ${diff.new_path}</strong>`;

                    const diffContentPre = document.createElement('pre');
                    diffContentPre.className = 'diff-content';
                    diffContentPre.textContent = diff.diff;
                    diffContentPre.style.display = 'none'; // Hidden by default

                    // Toggle visibility on click
                    filePathHeader.onclick = () => {
                        if (diffContentPre.style.display === 'none') {
                            diffContentPre.style.display = 'block';
                        } else {
                            diffContentPre.style.display = 'none';
                        }
                    };

                    diffContainer.appendChild(filePathHeader);
                    diffContainer.appendChild(diffContentPre);
                    diffsDiv.appendChild(diffContainer);
                });
            } else {
                diffsDiv.innerHTML += '<p>No file changes found between the selected branches.</p>';
            }
        }

        function displayError(message) {
            const errorMessagesDiv = document.getElementById('errorMessages');
            errorMessagesDiv.textContent = message;
            errorMessagesDiv.style.display = 'block';
        }

    </script>
</body>

</html>